이전 장까지 mysql의 구조 및 InnoDB의 구조를 알아봤다면, 이번 장에는 트랜잭션에 대해 공부 해보고자 한다. 어플리케이션 개발을 하면서 트랜잭션에 대해 중요성은 몸소 느꼈지만 다소 부족한 부분이 많다고 생각한다. 그렇기 때문에 이번 장을 통해 트랜잭션에 대해 좀 더 많이 알아 가는 시간이 되었으면 한다.

본격적으로 들어가기 전 잠금(Lock)과 트랜잭션은 비슷한 개념으로 보이지만 **잠금은 동시성을 제어하기 위한 기능, 트랜잭션은 데이터의 정합성을 위한 기능!
동시에 변경과 잠금, 그리고 정합성 이제 알아보자.**

---

### 트랜잭션

앞 장에서 이야기 했듯이 InnoDB는 레코드 별 잠금을 제공한다고 했다. **트랜잭션은 모두 적용되거나 모두 적용되지 않아야 하는 상황에서 힘을 발휘한다.**

하지만 트랜잭션을 주의해서 사용해야 한다. DBMS의 커넥션과 동일하게 꼭 필요한 최소의 코드에만 적용하는 것이 좋다. 왜냐하면 트랜잭션의 범위를 최소화 해야하기 때문이다.
다음 한 상황을 예로 들어보자. 게시판에 게시물을 작성한 후 저장 버튼을 클릭했을 때 서버에서 처리하는 내용을 순서대로 정리했다.

```
1) 애플리케이션에서 처리 시작
-> 데이터 베이스 커넥션 생성
-> 트랜잭션 시작
2) 사용자의 로그인 여부 확인
3) 사용자의 글쓰기 내용의 오류 확인 
4) 첨부로 업로드 된 파일 확인 및 저장
5) 사용자의 입력 내용을 DBMS에 저장
6) 첨부 파일 정보를 DBMS에 저장
7) 저장된 내용 또는 기타 정보를 DBMS에서 조회 
8) 게시물 등록에 대한 알림 메일 발송
9) 알람 메일 발송 이력을 DBMS에 저장
<- 트랜잭션종료(COMIT)
<- 데이터 베이스 커넥션 반납 
10) 처리완료
```

위 상황은 흔히 일어날 수 있고, 또 개발자라면 위와 같이 처리하는 사람이 많을 것으로 예상이 간다. **하지만 위 절차 중에서 DBMS의 트랜잭션 처리에 좋지 않다은 부분이 있다.**

1. 데이터 베이스의 커넥션을 먼저 생성, 트랜잭션을 종료 시킨 후 데이터 베이스 커넥션 반납을 진행한다. **또, 실제로 DBMS에 데이터 저장하는 작업은 5번부터 시작한다. 2~4번은 DBMS의 트랜잭션으로 포함 시킬 필요가 없다.**
    1. 이 부분은 나도…. 흔히 했던 것 같다. 습관적으로 `@Transactional` 를 쓴 나 자신을 반성하며… 또, 데이터 베이스 커넥션 개수도 제한적이라서 해당 행위는 옳지 않았다…
2. 8번 로직! 이 부분이 핵심이다. 메일 전송이나 FTP 파일 전송 작업 또는 네트워크를 통해 **외부 자원과 통신하는 경우 DBMS의 트랜잭션 내에서 제거하는 것이 좋다. 왜냐하면 발송 로직에서 에러가 발생할 경우 DBMS 서버와 웹 서버 둘다 위험에 빠지게 된다.**
    1. 이 부분은 나도 생각했던 부분! 메일 및 알람 발송은 트랜잭션을 분리 하여 개발 해야한다. 때문에, 나는 spring에서 지원하는 이벤트를 사용했던 것 같다.(나 나름 성장했다…)
3. 위 절차에서 DBMS의 작업이 크게 4가지가 있다. 입력한 정보 저장, 5,6번 작업은 반드시 하나의 트랜잭션으로 묶는다. 7번 작업은 DBMS에 저장 한 후 단순 조회기 때문에 트랜잭션에 포함할 필요가 없다. 이는 별도 트랜잭션으로 분리해도 된다는 말이다 또한, 9번 작업 또한, 성격이 다르기 때문에 별도 트랜잭션으로 분리하는 것이 좋다.

위 상황들을 고려하여 다시 수정해보자.

```
1) 처리 시작
2) 사용자의 로그인 여부 확인
3) 사용자의 글쓰기 내용의 오류 발생 여부 확인
4) 첨부로 업로드 된 파일 확인 및 저장
-> 데이터 베이스 커넥션 생성
-> 트랜잭션 시작
5) 사용자의 입력 내용을 저장
6) 첨부 파일 정보 저장
<- 트랜잭션종료(COMMIT)
7) 저장된 내용 또는 기타 정보를 DBMS에서 조회 
8) 게시물 등록에대한 알림 메일 발송
-> 트랜잭션 시작
9) 알림 메일 발송 이력을 DBNS에 저장
<- 드랜잭션종료(COMIT)
<- 데이터 베이스 커넥션 종료
10) 처리완료
```

위 설계가 최적의 설계는 아니지만 얘기하고자 하는 것은 **데이터 베이스 커넥션을 가지고 있는 범위와 트랜잭션이 활성화 되어 있는 범위를 최소화 해야 한다는 것이다. 코드 라인 수는 한 두줄이라도 네트워크 작업이 있는 경우 반드시 트랜잭션에 배제해야한다. 실수로 인해 웹 및 DBMS 서버가 높은 부하로 빠지고 위험 상태가 된다.**