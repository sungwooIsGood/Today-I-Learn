### 폼 인증이란?

- HTTP기반의 폼 로그인 인증 메커니즘을 활성화 하는 API로서 사용자 인증을 위한 사용자 정의 로그인 페이지를 쉽게 구현할 수 있다.
- 기본적으로 **스프링 시큐리티가 제공하는 기본 로그인 페이지를 사용하며 사용자이름과 비밀번호 필드가 포함된 간단한 로그인 양식을 제공한다.**
- 사용자는 웹 폼을 통해 자격증명(사용자 이름과 비밀번호)을 제공하고SpringSecurity는 HttpServletRequest에서 이 값을 읽어온다.

### 폼 인증 흐름

<img width="675" alt="스크린샷 2024-06-30 오후 4 18 49" src="https://github.com/sungwooIsGood/Today-I-Learn/assets/98163632/3da16693-8f60-42ea-a8c9-7e22df8f8819">
1. client가 GET매핑으로 /user API로 request
2. SecurityFilterChain에서 맨 마지막 Filter인 AuthorizationFilter(권한 검사 필터)에서 인증 처리를 진행하게 된다.
3. 만약 인증을 받지 못했다면 혹 인증을 받지 못한 유저라면 → 익명의 유저, 접근 예외가 발생한다. ⇒ AccessDeniedException
4. 예외를 처리하는 필터인 ExceptionTranslationFilter가 예외에 대한 처리를 시작
5. 인증을 시작하게 만들기 위한 밑작업이 시작한다.
    1. AuthenticationEntryPoint
6. 로그인 페이지로 리다이렉션 시킨다.
7. 로그인 페이지에서 로그인이 성공적으로 되었다면 Server로 요청을 보낸다.

### formLogin() API

- FormLoginConfigurer 설정 클래스를 통해 여러 API들을 설정할 수 있다.
- 내부적으로 UsernamePasswordAuthenticationFilter가 생성되어 **폼 방식의 인증 처리를 담당하게 된다.**

### 실습

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http.authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
            .formLogin(form -> form
                    .loginPage("/loginPage")
                    .loginProcessingUrl("/loginProc")
                    .defaultSuccessUrl("/",true)
                    .failureForwardUrl("/failed")
                    .usernameParameter("userId")
                    .passwordParameter("password")
                    .successHandler((request,response,authentication) -> {
                        System.out.println("authentication: " + authentication);
                        response.sendRedirect("/home");
                    })
                    .failureHandler(((request, response, exception) -> {
                        System.out.println("exception: " + exception.getMessage());
                        response.sendRedirect("/login");
                    }))
                    .permitAll()
            );

    return http.build();
}
```

- `loginPage()` : 사용자 정의 로그인 페이지로 전환, 기본 페이지 무시
- `loginProcessingUrl()` : 사용자 이름과 비밀번호를 검증할 URL (Form action) 지정
- `defaultSuccessUrl("",{alwaysUse})` : 로그인 성공 이후 이동할 페이지를 정의, alwaysUse 가 true면 무조건 지정된 위치로 이동, 반대로 default는 false → 인증 전에 보안이 필요한 페이지를 방문하다가 인증에 성공한 경우면 이전 위치로 리다이렉트 됨.
- `failureForwardUrl()` : 인증에 실패할 경우 사용자에게 보내질 URL 지정 기본은 /login?error 이다.
- `usernameParameter()` : 인증 수행 할 때, 아이디를 찾기 위한 매개변수 기본 값은 username이다.
- `passwordParameter()` : 인증 수행 할 때, 비밀번호를 찾기 위한 매개변수 기본 값은 password이다.
- `successHandler()` : 인증 성공 시 사용할 AuthenticationSuccessHandler이다. 기본 값은 SavedRequestAwareAuthenticationSuccessHandler이다. 사실 `defaultSuccessUrl()` 메서드 내에서 `successHandler()` 를 정의한다. 우린 즉, 커스텀을 한다는 것이다. 그렇기 때문에`defaultSuccessUrl()` 보다 `successHandler()` 가 우선순위가 더 높다.
- `failureHandler()` : 인증 실패 시 사용할 AuthenticationFailureHandler 이다. 기본 값은 SimpleUrlAuthenticationFailureHandler를 사용하여 /login?error로 리다이렉션 시킨다. 위 `defaultSuccessUrl()` 와 동작은 똑같다.
- `permitAll()` : `failureUrl(), loginPage(), loginProcessingUrl()`에 대한 URL에 모든 사용자의 접근을 허용한다.